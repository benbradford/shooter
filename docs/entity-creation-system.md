# Entity Creation System

## Overview

All entities in the game are defined in a unified `entities` array in level JSON files. Entities can be created immediately on level load or delayed until an event fires.

## Core Concepts

### Entity IDs
- Every entity has a unique ID: `{type}{number}` (e.g., `skeleton0`, `thrower1`)
- Auto-generated by editor using lowest available number
- Duplicate IDs throw error during level load
- Player always has ID "player" (not in entities array)

### Entity Types
- `skeleton` - Throws bone projectiles
- `thrower` - Throws grenades
- `stalking_robot` - Patrols waypoints, shoots fireballs
- `bug_base` - Spawns bugs continuously
- `bullet_dude` - Shoots bullets
- `trigger` - Invisible area that fires event when player enters
- `exit` - Level transition portal
- `eventchainer` - Raises multiple events sequentially with delays

### Event-Driven Creation
- Entities have optional `createOnEvent` field
- If `createOnEvent` set: Entity spawns when that event fires
- If no `createOnEvent`: Entity spawns immediately on level load
- EntityCreatorManager handles registration and creation
- Once event fires, EntityCreatorManager unsubscribes (event can only fire once)

## Level JSON Format

```json
{
  "width": 40,
  "height": 30,
  "playerStart": {"x": 15, "y": 19},
  "entities": [
    {
      "id": "skeleton0",
      "type": "skeleton",
      "data": {
        "col": 10,
        "row": 5,
        "difficulty": "easy"
      }
    },
    {
      "id": "skeleton1",
      "type": "skeleton",
      "createOnEvent": "sk1",
      "data": {
        "col": 15,
        "row": 10,
        "difficulty": "medium"
      }
    },
    {
      "id": "trigger1",
      "type": "trigger",
      "data": {
        "eventToRaise": "spawn_wave",
        "triggerCells": [{"col": 12, "row": 23}],
        "oneShot": true
      }
    },
    {
      "id": "eventchainer1",
      "type": "eventchainer",
      "createOnEvent": "spawn_wave",
      "data": {
        "col": 14,
        "row": 23,
        "eventsToRaise": [
          {"event": "sk1", "delayMs": 0},
          {"event": "sk2", "delayMs": 1000}
        ]
      }
    }
  ],
  "cells": [...],
  "levelTheme": "dungeon",
  "background": {...}
}
```

## Entity Data Fields

### Common Fields (all entities)
- `col`: Grid column position
- `row`: Grid row position

### Enemy Entities (skeleton, thrower, robot, bug_base, bullet_dude)
- `difficulty`: "easy" | "medium" | "hard"
- `waypoints`: Array of {col, row} (stalking_robot only)

### Trigger
- `eventToRaise`: Event name to fire
- `triggerCells`: Array of {col, row} cells that activate trigger
- `oneShot`: Boolean (default true)

### Exit
- `targetLevel`: Level filename without .json
- `targetCol`: Spawn column in target level
- `targetRow`: Spawn row in target level
- `triggerCells`: Array of {col, row} cells that activate exit
- `oneShot`: Boolean (default true)

### EventChainer
- `eventsToRaise`: Array of {event: string, delayMs: number}
- Raises events sequentially with specified delays

## How It Works

### EntityCreatorManager

Manages event-driven entity creation:

```typescript
class EntityCreatorManager implements EventListener {
  register(createOnEvent: string, creator: () => Entity): void
  onEvent(createOnEvent: string): void  // Creates entity when event fires
  clear(): void
}
```

- Implements EventListener to receive events from EventManagerSystem
- Registers entity creators for delayed spawning
- Creates entity when event fires and adds to EntityManager
- Automatically deregisters after creation
- Throws error if same event fires twice

### EntityLoader

Handles entity loading from level JSON:

```typescript
class EntityLoader {
  loadEntities(levelData: LevelData, player: Entity): void
}
```

- Validates unique entity IDs
- Creates entity creators for each entity definition
- Registers event-driven entities with EntityCreatorManager
- Creates immediate entities and adds to EntityManager

### Entity Creation Flow

1. **Level loads** - EntityLoader.loadEntities() called
2. **Validate IDs** - Check for duplicates, throw error if found
3. **For each entity**:
   - Create entity creator function
   - If `createOnEvent`: Register with EntityCreatorManager
   - If no `createOnEvent`: Create immediately and add to EntityManager
4. **When event fires**:
   - EntityCreatorManager.onEvent() called
   - Entity creator function executed
   - Entity added to EntityManager
   - EntityCreatorManager deregisters from event

## Example Flows

### Simple Spawn
```json
{
  "id": "skeleton0",
  "type": "skeleton",
  "data": {"col": 10, "row": 5, "difficulty": "easy"}
}
```
→ Spawns immediately on level load

### Event-Driven Spawn
```json
{
  "id": "trigger1",
  "type": "trigger",
  "data": {
    "eventToRaise": "spawn_wave",
    "triggerCells": [{"col": 12, "row": 23}],
    "oneShot": true
  }
},
{
  "id": "skeleton1",
  "type": "skeleton",
  "createOnEvent": "spawn_wave",
  "data": {"col": 15, "row": 10, "difficulty": "medium"}
}
```
→ Player walks to (12, 23) → trigger fires "spawn_wave" → skeleton1 spawns

### Sequential Spawning with EventChainer
```json
{
  "id": "trigger1",
  "type": "trigger",
  "data": {
    "eventToRaise": "start_wave",
    "triggerCells": [{"col": 12, "row": 23}],
    "oneShot": true
  }
},
{
  "id": "eventchainer1",
  "type": "eventchainer",
  "createOnEvent": "start_wave",
  "data": {
    "col": 14,
    "row": 23,
    "eventsToRaise": [
      {"event": "sk1", "delayMs": 0},
      {"event": "sk2", "delayMs": 1000},
      {"event": "th1", "delayMs": 500}
    ]
  }
},
{
  "id": "skeleton1",
  "type": "skeleton",
  "createOnEvent": "sk1",
  "data": {"col": 15, "row": 10, "difficulty": "medium"}
},
{
  "id": "skeleton2",
  "type": "skeleton",
  "createOnEvent": "sk2",
  "data": {"col": 17, "row": 10, "difficulty": "hard"}
},
{
  "id": "thrower1",
  "type": "thrower",
  "createOnEvent": "th1",
  "data": {"col": 19, "row": 10, "difficulty": "medium"}
}
```

Flow:
1. Player walks to (12, 23)
2. trigger1 fires "start_wave"
3. eventchainer1 spawns and starts
4. eventchainer1 raises "sk1" (0ms) → skeleton1 spawns
5. eventchainer1 raises "sk2" (1000ms) → skeleton2 spawns
6. eventchainer1 raises "th1" (500ms) → thrower1 spawns
7. eventchainer1 destroys itself

## Editor Integration

### Adding Entities

1. Click **Add** button
2. Select entity type from dropdown
3. Click to place (auto-generates ID)
4. Stays in add mode for multiple placements

### Editing Entities

1. Click any entity
2. Entity ID shows in top-right corner
3. Edit panel appears with difficulty buttons
4. Click difficulty to change (updates both component and level data)
5. Click entity again to move it

### Saving

Click **Log** button to save level JSON with all entities in the new format.

## Key Files

- `src/systems/EntityCreatorManager.ts` - Event-driven entity creation
- `src/systems/EntityLoader.ts` - Entity loading from JSON
- `src/systems/level/LevelLoader.ts` - LevelEntity and EntityType definitions
- `src/eventchainer/EventChainerEntity.ts` - EventChainer entity
- `src/ecs/components/eventchainer/EventChainerComponent.ts` - EventChainer logic
- `src/editor/AddEntityEditorState.ts` - Unified entity placement
- `src/scenes/EditorScene.ts` - Entity extraction to JSON

## Migration Notes

All levels have been converted to the new format. Old fields (robots, bugBases, throwers, skeletons, bulletDudes, triggers, spawners, exits) are no longer used.

If you see old format in a level file, it needs to be converted to use the `entities` array.
